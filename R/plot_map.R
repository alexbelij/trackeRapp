#' Plot all selected workouts on an interactive leaflet map.
#'
#' @param x An object of class \code{\link{trackeRdata}}.
#' @param sumX An object of class \code{trackeRdataSummary}.
#' @param session A numeric vector of the sessions to be plotted. Defaults to
#'     all sessions.
#' @param threshold Logical. Should thresholds be applied?
#' @param preped_route A dataframe (optional). A user can provide a dataframe generated by \code{prepRoute}.
plot_map <- function(x, sumX, preped_route = NULL, session = NULL, threshold = TRUE) {
  if (is.null(session)) session <- seq_along(x)
  all_sessions <- seq_along(x)
  if (is.null(preped_route)) {
    ## get prepared data.frame
    df <- prepare_route(x, session = session, threshold = threshold)
  } else {
    df <- preped_route
  }
  ## prepare popups
  units <- getUnits(x)
  popupText <- function(session, start = TRUE, speed) {
    session <- unique(session)
    w <- which(sumX$session == session)
    unitDist4pace <- strsplit(
      units$unit[units$variable == "pace"],
      split = "_per_"
    )[[1]][2]
    avgPace <- floor(sumX$avgPace[w] * 100) / 100

    paste(
      paste("Session:", session),
      # paste(sumX$sessionStart[w], "-", sumX$sessionEnd[w]),
      paste("Distance:", round(sumX$distance[w], 2), units$unit[units$variable == "distance"]),
      paste("Duration:", round(as.numeric(sumX$duration[w]), 2), units(sumX$duration[w])),
      paste(
        paste0("Avg. pace (per 1 ", unitDist4pace, "):"),
        paste(floor(avgPace), round(avgPace %% 1 * 60, 0), sep = ":"), "min:sec"
      ),
      paste("Current speed:", round(speed, 1), lab_sum(feature = "avgSpeed", data = sumX, whole_text = FALSE)),
      sep = "\n"
    )
  }
  p <- plotly::plot_mapbox()
  for (i in all_sessions) {
    plot_df <- df[which(df$SessionID == i), ]
    df_markers <- plot_df[seq(1, nrow(plot_df), round(nrow(plot_df) / 10, 0)), ]
    df_markers$true_session_id <- i

    p <- plotly::add_markers(
      p,
      data = df_markers, x = ~ longitude, y = ~ latitude, alpha = 0,
      size = I(0.1), key = ~ true_session_id, color = I("deepskyblue3")
    )

    p <- plotly::add_paths(
      p,
      data = plot_df, x = ~ longitude, y = ~ latitude,
      size = I(2), color = I("deepskyblue3"),
      text = ~ popupText(session = SessionID, speed = speed)
    )
  }
  # ## add trace + markers + popups
  # if (!(identical(all_sessions, session))) {
  #   for (i in session) {
  #     plot_df <- df[which(df$SessionID == i), ]
  #     df_markers <- plot_df[seq(1, nrow(plot_df), round(nrow(plot_df) / 10, 0)), ]
  #     df_markers$true_session_id <- i
  #     p <- plotly::add_markers(
  #       p, data = df_markers, x = ~longitude, y = ~latitude,
  #       size = I(2), key = ~true_session_id, color = I("darkorange3")
  #     )
  #     p <- plotly::add_paths(
  #       p, data = plot_df, x = ~longitude, y = ~latitude,
  #       size = I(2), color = I("darkorange3"),
  #       text = ~popupText(session = SessionID, speed = speed)
  #     )
  #   }
  # }
  center_lat <- median(df$latitude[which(df$SessionID %in% session)])
  center_lon <- median(df$longitude[which(df$SessionID %in% session)])

  # map style buttons
  basic <- list(
    method = "relayout",
    args = list(list(mapbox.style = "basic")),
    label = "Basic"
  )

  dark <- list(
    method = "relayout",
    args = list(list(mapbox.style = "dark")),
    label = "Dark"
  )

  button <- function(map_type, label) {
    list(
      method = "relayout",
      args = list(list(mapbox.style = map_type)),
      label = label
    )
  }

  updatemenus <- list(
    list(
      type = "buttons",
      direction = "right",
      yanchor = "bottom",
      pad = list("r" = 10, "t" = 10, "b" = 10),
      x = 1,
      y = 0,
      buttons = list(
        button("basic", "Basic"), button("streets", "Streets"),
        button("outdoors", "Outdoors"), button("light", "Light"),
        button("dark", "Dark"), button("satellite", "Satellite"),
        button("satellite-streets", "Satellite streets")
      )
    )
  )

  diff_lon <- abs(max(df$longitude[which(df$SessionID %in% session)]) - min(df$longitude[which(df$SessionID %in% session)]))

  p <- plotly::layout(
    p,
    mapbox = list(
      zoom = 2.3,
      center = list(lat = center_lat, lon = center_lon),
      style = "dark"
    ), dragmode = "select", showlegend = FALSE, updatemenus = updatemenus,
    margin = list(l = 0, r = 0, t = 0, b = 0)
  )
  return(p)
}
